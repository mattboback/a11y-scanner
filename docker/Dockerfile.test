
FROM mcr.microsoft.com/playwright/python:v1.54.0-jammy

ENV PYTHONUNBUFFERED=1
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

USER root
# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
RUN rm -rf /var/lib/apt/lists/*

USER pwuser
WORKDIR /home/pwuser

# Copy project files
COPY --chown=pwuser:pwuser pyproject.toml uv.lock ./
COPY --chown=pwuser:pwuser src ./src
COPY --chown=pwuser:pwuser tests ./tests

# Install dependencies with test extras
RUN uv sync --frozen --all-extras

# Add uv-managed bin directory to PATH
ENV PATH="/home/pwuser/.venv/bin:$PATH"

# Default command runs pytest
CMD ["pytest", "-v", "--tb=short"]
